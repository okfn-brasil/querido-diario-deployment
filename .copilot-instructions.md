# GitHub Copilot Guidelines - Querido Di√°rio Deployment

## Arquitetura do Projeto
- **Orquestra√ß√£o**: Docker Compose com profiles (dev/prod/processing)
- **Reverse Proxy**: Traefik com SSL autom√°tico (Let's Encrypt)
- **Automa√ß√£o**: Makefile para comandos simplificados
- **Configura√ß√£o**: Templates como fonte √∫nica da verdade
- **Ambientes**: Desenvolvimento local + Produ√ß√£o externa

## Estrutura do Projeto

```
querido-diario-deployment/
‚îú‚îÄ‚îÄ templates/              # SOURCE OF TRUTH - Templates principais
‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml  # Configura√ß√£o completa
‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.dev.yml # Overrides para dev
‚îÇ   ‚îî‚îÄ‚îÄ env.prod.sample     # Template de vari√°veis
‚îú‚îÄ‚îÄ docs/                   # Documenta√ß√£o t√©cnica
‚îú‚îÄ‚îÄ init-scripts/          # Scripts de inicializa√ß√£o DB
‚îú‚îÄ‚îÄ Makefile               # Comandos de automa√ß√£o
‚îî‚îÄ‚îÄ .env                   # GERADO - N√£o commitar
```

## Padr√µes de Configura√ß√£o

### Docker Compose
```yaml
# Use profiles para separar ambientes
services:
  postgres:
    profiles:
      - dev
      - development
  
  api:
    profiles:
      - dev
      - prod
      - processing
```

### Traefik Labels
```yaml
# Padr√£o para servi√ßos web
labels:
  - "traefik.enable=true"
  - "traefik.http.routers.${SERVICE}.rule=Host(`${SERVICE}.${DOMAIN}`)"
  - "traefik.http.routers.${SERVICE}.tls.certresolver=leresolver"
  - "traefik.http.services.${SERVICE}.loadbalancer.server.port=${PORT}"
```

### Environment Variables
```yaml
# Use interpola√ß√£o para valores din√¢micos
environment:
  - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}/${POSTGRES_DB}
  - ALLOWED_HOSTS=${DOMAIN},api.${DOMAIN}
```

## Conven√ß√µes de Nomenclatura

### Servi√ßos Docker
- **Container names**: `querido-diario-{service}` (ex: `querido-diario-api`)
- **Service names**: Nome simples (ex: `api`, `backend`, `postgres`)
- **Networks**: `backend` (internal), `frontend` (external/traefik)

### Vari√°veis de Ambiente
- **Prefixos por servi√ßo**: `QD_API_`, `QD_BACKEND_`, `QD_DATA_`
- **Infraestrutura**: `POSTGRES_`, `OPENSEARCH_`, `STORAGE_`
- **Deployment**: `{SERVICE}_MEMORY_LIMIT`, `{SERVICE}_REPLICAS`

### Volumes
```yaml
# Nomea√ß√£o consistente
volumes:
  postgres-data:
  opensearch-data:
  static-files:
  traefik-acme:
```

## Makefile Patterns
```makefile
# Use targets descritivos com help
dev: ## Inicia ambiente de desenvolvimento completo
    @echo "üöÄ Iniciando ambiente de desenvolvimento..."
    docker compose --profile dev up -d

# Valida√ß√£o antes de execu√ß√£o
validate: ## Valida sintaxe dos arquivos docker-compose
    @echo "‚úÖ Validando configura√ß√µes..."
    docker compose config > /dev/null
```

## Health Checks
```yaml
# Sempre inclua health checks
healthcheck:
  test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 40s
```

## Desenvolvimento vs Produ√ß√£o

### Desenvolvimento (Profile: dev)
- Containers locais para toda infraestrutura
- HTTP (sem SSL)
- Debug habilitado
- Portas expostas para acesso direto
- Dom√≠nio local: `queridodiario.local`

### Produ√ß√£o (Profile: prod)
- Servi√ßos externos (PostgreSQL, OpenSearch, S3)
- HTTPS obrigat√≥rio
- SSL autom√°tico via Let's Encrypt
- Limites de recursos configurados
- Health checks rigorosos

## N√ÉO FAZER
- N√£o commitar arquivos `.env`
- N√£o usar `latest` tags em produ√ß√£o
- N√£o expor portas desnecess√°rias em produ√ß√£o
- N√£o usar `depends_on` sem health checks
- N√£o misturar configura√ß√µes de dev/prod no mesmo servi√ßo

## Troubleshooting Patterns
```makefile
logs-%: ## Mostra logs de um servi√ßo espec√≠fico (ex: make logs-api)
    docker compose logs -f $*

shell-%: ## Acesso shell a um container (ex: make shell-api)
    docker compose exec $* /bin/bash
```